<!DOCTYPE html>
<html lang="pt-br">
<head>
	<meta charset="utf-8">
	<meta name="viewport"content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
	<link rel="stylesheet" href="/drogaria/assets/css/style.css">
	<title>Farmácia Bem-estar</title>
	<link rel="icon" type="image/x-icon" href="/drogaria/assets/images/favicon.ico">
</head>
<body>

<div id="header-placeholder"></div>

<main class="container mt-5" style="min-height: 80vh">
	
	<div id="saudacao"></div>
	
	<!-- Carrossel -->
	<div id="carousel" class="carousel slide mb-5" data-ride="carousel">
		<ol class="carousel-indicators">
			<li data-target="#carousel" data-slide-to="0" class="active"></li>
			<li data-target="#carousel" data-slide-to="1"></li>
			<li data-target="#carousel" data-slide-to="2"></li>
		</ol>
		<div class="carousel-inner">
			<div class="carousel-item active">
				<img src="/drogaria/assets/images/1.png"
					class="d-block w-100 rounded" alt="...">
			</div>
			<div class="carousel-item">
				<img src="/drogaria/assets/images/2.png"
					class="d-block w-100 rounded" alt="...">
			</div>
			<div class="carousel-item">
				<img src="/drogaria/assets/images/3.png"
					class="d-block w-100 rounded" alt="...">
			</div>
		</div>
		<button class="carousel-control-prev" type="button"
			data-target="#carousel" data-slide="prev">
			<span class="carousel-control-prev-icon" aria-hidden="true"></span> <span
				class="sr-only">Previous</span>
		</button>
		<button class="carousel-control-next" type="button"
			data-target="#carousel" data-slide="next">
			<span class="carousel-control-next-icon" aria-hidden="true"></span> <span
				class="sr-only">Next</span>
		</button>
	</div>


	<!-- Sessão de medicamentos -->
		<!--  Em destaque -->
		<div class="container mb-5" id="destaque-medicamentos">
		  <div class="mb-5 d-flex justify-content-between align-bottom">
		    <h3>Em destaque</h3>
		  </div>
		  <div class="row" id="destaque-container"></div>
		</div>
		
		<div class="container mb-5" id="todos-medicamentos">
		  <div class="mb-5 d-flex justify-content-between align-bottom">
		    <h3>Todos os medicamentos</h3>
		   	<a href="/drogaria/medicamento/lista-medicamentos.html" class="text-secondary">Ver mais</a>
		  </div>
		  <div class="row" id="todos-container"></div>
		</div>
	
	    <div class="container mt-3 mb-5 p-3 bg-light" id="sem-medicamentos">
	        <p class="text-center text m-1">No momento estamos sem medicamentos cadastrados :/</p>
	    </div>

	<!-- Sessão vantagens e cadastro -->
	<section id="vantagens"></section>

	<!-- Modal de login -->
	<div class="modal fade" id="loginModal" tabindex="-1"
		aria-labelledby="loginModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content border-0 shadow-lg">
				<div class="modal-header bg-cyan">
					<h5 class="modal-title">Acesso Restrito</h5>
					<button type="button" class="close text-white" data-dismiss="modal"
						aria-label="Fechar">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<p>Para acessar este conteúdo, você precisa estar logado.</p>
					<div class="d-flex justify-content-between">
						<a href="/drogaria/public/cadastrar.html"
						class="btn btn-secondary w-100 m-1">Criar uma conta</a>
						<a href="/drogaria/public/login.html"
						class="btn bg-cyan w-100 m-1">Fazer login</a> 
					</div>
				</div>
			</div>
		</div>
	</div>
</main>
<div id="modais-container"></div>
<div id="footer-placeholder"></div>

<script src="/drogaria/assets/js/index.js"></script>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="/drogaria/assets/js/header_footer_include.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/drogaria/assets/js/sweet_alerts.js"></script>
<script src="/drogaria/assets/js/exibe_mensagem.js"></script>

<script src="/drogaria/assets/js/cadastro_usuario.js"></script>

<script>

	let listaDeCategorias = [];

document.addEventListener("footer-carregado", async () => {
	  try {
	    // Busca categorias primeiro (essencial para modais)
	    const catResponse = await fetch("/drogaria/CategoriaServlet");
	    if (!catResponse.ok) throw new Error('Falha ao buscar categorias');
	    listaDeCategorias = await catResponse.json();

	    // Em seguida, busca medicamentos
	    const medResponse = await fetch("/drogaria/ReadMedicamentoServlet");
	    if (!medResponse.ok) throw new Error('Falha ao carregar medicamentos');
	    const lista = await medResponse.json();

	    const destaqueContainer = document.getElementById("destaque-container");
	    const todosContainer = document.getElementById("todos-container");
	    const modaisContainer = document.getElementById("modais-container");

	    if (!lista || lista.length === 0) {
	      document.getElementById("destaque-medicamentos").remove();
	      document.getElementById("todos-medicamentos").remove();
	    } else {
	      document.getElementById("sem-medicamentos").remove();

	      const usuarioLogadoJSON = sessionStorage.getItem('usuarioLogado');
	      const usuarioLogado = usuarioLogadoJSON ? JSON.parse(usuarioLogadoJSON) : null;

	      const destaque = [...lista].slice(-4).reverse();
	      const todos = [...lista].slice(0, 8);

	      const processarLista = (container, listaDeMeds) => {
	        listaDeMeds.forEach(med => {
	          const card = criaCard(med, usuarioLogado);
	          container.appendChild(card);
	          if (usuarioLogado && usuarioLogado.isAdmin) {
	            modaisContainer.appendChild(criarModalMedicamento(med));
	          }
	        });
	      };

	      processarLista(destaqueContainer, destaque);
	      processarLista(todosContainer, todos);

	      configurarBotoesExcluirMedicamento();
	    }
	  } catch (e) {
	    console.error("Erro ao carregar a página:", e);
	  }
	});

  function formatarPreco(valor) {
    return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
  }

  function criaCard(med, usuarioLogado) {
	    const col = document.createElement("div");
	    col.className = "col-md-3 col-sm-12 mb-4 d-flex flex-column align-items-center hover-card";

	    const imgUrl = med.imagem_url?.trim() || "/drogaria/assets/images/semimagem.png";
	    
	    if (usuarioLogado && usuarioLogado.isAdmin) {
	        col.setAttribute("data-toggle", "modal");
	        col.setAttribute("data-target", `#modal-${med.id}`);
	    }

	    let cardHtml = `
	        <img src="${imgUrl}" alt="${med.nome}" class="img-fluid mb-4" style="max-height:120px;"
	             onerror="this.onerror=null;this.src='/drogaria/assets/images/semimagem.png';">
	        <div class="p-3 w-100 bg-cyan-light" style="border-radius: 6px;">
	            <p class="txt-cyan" style="font-size: 20px; font-weight: bold; margin: 0">${med.nome}</p>
	            <p class="txt-cyan" style="margin: 0">${med.dosagem}</p>
	    `;

	    if (usuarioLogado) {
	        // Se o usuário está LOGADO, mostra o desconto (se houver)
	        const descontoProduto = med.desconto || 0;
	        if (descontoProduto > 0) {
	            const precoFinal = med.preco * (1 - (descontoProduto / 100));
	            cardHtml += `
	                <p class="mt-1 mb-0 text-secondary" style="font-size: 15px; text-decoration: line-through;">${formatarPreco(med.preco)}</p>
	                <div class="d-flex justify-content-between align-items-center" style="font-size: 20px; font-weight: bold;">
	                    <p class="mb-0">${formatarPreco(precoFinal)}</p>
	                    <p class="text-danger mb-0"><i class="fas fa-solid fa-tag"></i> -${descontoProduto.toFixed(0)}%</p>
	                </div>`;
	        } else {
	            // Logado, mas o produto não tem desconto
	            cardHtml += `<p class="mt-1 mb-0" style="font-size: 20px; font-weight: bold;">${formatarPreco(med.preco)}</p>`;
	        }
	    } else {

			cardHtml += `<p class="mt-1 mb-0" style="font-size: 20px; font-weight: bold;">${formatarPreco(med.preco)}</p>`;
	    }
	    
	    // Adiciona o botão "Editar" visualmente se for admin
	    if (usuarioLogado && usuarioLogado.isAdmin) {
	        cardHtml += `<span class="btn btn-link mt-2 p-0 txt-cyan"><i class="fas fa-edit"></i> Editar</span>`;
	    }
	    
	    cardHtml += `</div>`;
	    col.innerHTML = cardHtml;
	    return col;
	}

  function criarModalMedicamento(med) {
    const modalDiv = document.createElement('div');
    modalDiv.className = 'modal fade';
    modalDiv.id = `modal-${med.id}`;
    modalDiv.tabIndex = -1;
    
    let optionsHtml = listaDeCategorias.map(cat => `<option value="${cat.value}" ${med.categoria === cat.value ? 'selected' : ''}>${cat.text}</option>`).join('');
    
    modalDiv.innerHTML = `
      <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
          <form class="row p-4">
            <div class="modal-header col-12"><h5 class="modal-title">Editar Medicamento</h5><button type="button" class="close" data-dismiss="modal" aria-label="Fechar"><span aria-hidden="true">&times;</span></button></div>
            <input type="hidden" name="id" value="${med.id}" />
            <div class="col-md-6 mb-3 mt-3"><label>Nome</label><input type="text" class="form-control" name="nome" value="${med.nome}" required></div>
            <div class="col-md-6 mb-3 mt-3"><label>Categoria</label><select class="form-control" name="categoria" required><option value="">Selecione...</option>${optionsHtml}</select></div>
            <div class="col-md-6 mb-3"><label>Princípio Ativo</label><input type="text" class="form-control" name="principio_ativo" value="${med.principio_ativo}" required></div>
            <div class="col-md-6 mb-3"><label>Fabricante</label><input type="text" class="form-control" name="fabricante" value="${med.fabricante}" required></div>
            <div class="col-md-6 mb-3"><label>Validade</label><input type="date" class="form-control" name="validade" value="${med.validade}" required></div>
            <div class="col-md-6 mb-3"><label>Lote</label><input type="text" class="form-control" name="lote" value="${med.lote}" required></div>
            <div class="col-md-6 mb-3"><label>Indicação</label><input type="text" class="form-control" name="indicacao" value="${med.indicacao}" required></div>
            <div class="col-md-6 mb-3"><label>Dosagem</label><input type="text" class="form-control" name="dosagem" value="${med.dosagem}" required></div>
            <div class="col-md-6 mb-3"><label>Forma</label><input type="text" class="form-control" name="forma" value="${med.forma}" required></div>
            <div class="col-md-6 mb-3"><label>Preço</label><input type="number" step="0.01" class="form-control" name="preco" value="${med.preco}" required></div>
            <div class="col-md-6 mb-3"><label>Desconto (%)</label><input type="number" step="0.01" class="form-control" name="desconto" value="${med.desconto || ''}"  min='0' max='100'></div>
            <div class="col-md-6 mb-3"><label>URL da Imagem</label><input type="url" class="form-control" name="imagem_url" value="${med.imagem_url || ''}" maxlength="255"></div>
            <div class="col-12 d-flex justify-content-between mt-3">
              <a href="#" data-id="${med.id}" data-nome="${med.nome}" class="btnExcluirMedicamento btn btn-danger">Excluir</a>
              <button type="submit" class="btn bg-cyan">Salvar alterações</button>
            </div>
          </form>
        </div>
      </div>
    `;
    return modalDiv;
  }
  
  document.addEventListener("DOMContentLoaded", function () {
	  const modaisContainer = document.getElementById('modais-container');
	  if (!modaisContainer) return;

	  modaisContainer.addEventListener('submit', async function (e) {
	    if (e.target.tagName.toLowerCase() !== 'form') return;
	    e.preventDefault();
	    const form = e.target;
	    const formData = new URLSearchParams();
	    for (const element of form.elements) {
	      if (element.name && !element.disabled) {
	        formData.append(element.name, element.value);
	      }
	    }
	    try {
	      const response = await fetch('/drogaria/UpdateMedicamentoServlet', { method: 'POST', body: formData });
	      const json = await response.json();
	      if (json.success) {
	        $(`#${form.closest('.modal').id}`).modal('hide');
	        sessionStorage.setItem("mensagem", json.message);
	        sessionStorage.setItem("mensagem-cor", "alert-success");
	        window.location.reload(); // Recarrega a página index para ver a mudança
	      } else {
	        exibe_mensagem(json.message, "alert-danger");
	      }
	    } catch (error) {
	      console.error('Erro na atualização:', error);
	      exibe_mensagem("Erro ao atualizar. Tente novamente mais tarde.", "alert-danger");
	    }
	  });
  });
</script>
</body>
</html>